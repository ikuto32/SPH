# SPH

This repository contains a simple Smoothed Particle Hydrodynamics (SPH) simulation.

## Build instructions

### Visual Studio

1. Open `WindowsProject_optimization_SPH.sln` with Visual Studio 2022 (or
   newer).
2. Select the `x64` configuration and build either `Debug` or `Release`.
3. Binaries will be placed in `x64/Debug` or `x64/Release`.
4. Add the new GPU sources `src/sph/gpu/hash_grid_2d.cu` and
   `src/sph/gpu/neighbor_search_2d.cu` to the project when enabling the
   optional 2D hash grid (`SPH_ENABLE_HASH2D`).
   Define the macro `SPH_ENABLE_HASH2D` in the project properties if you want
   to use the GPU neighbour search.

### CMake

The library and Python bindings can also be built on platforms that have
CMake available.

1. Execute the setup script to install dependencies and perform an initial
   build:

   ```console
   ./setup.sh
   ```

2. To run CMake manually, use the following commands:

   ```console
   mkdir build
   cd build
   cmake -DUSE_CUDA=OFF -DSPH_ENABLE_HASH2D=ON ..
   cmake --build . --target _sph
   ```

   The resulting `_sph` Python extension is created inside the `build`
   directory.

Building with CUDA support requires the CUDA Toolkit 12 or newer.

## Using the Python module

The bindings expose a `PyWorld` class:

```python
from _sph import PyWorld
w = PyWorld()
w.step(1/60.0)
positions = w.get_positions()
```

## Running the example GUI

After building the Visual Studio solution an executable named
`WindowsProject_optimization_SPH.exe` will be produced inside the build
output directory.  Launching this executable starts the example GUI
showing the SPH simulation.

While running the GUI you can control the simulation using the keyboard:

- Press **Space** to pause or resume.
- When paused, press **S** to advance a single time step.
- Press **R** to restart the simulation.

## Running the Python demo

After building the `_sph` Python extension a small demo can be launched
using Pygame:

```console
python examples/run_gui.py
```

### GPU neighbour search

The optional GPU-based neighbour search relies on a 2D hash grid. Enable it by
defining `SPH_ENABLE_HASH2D` during the build. When active and compiled with CUDA
support, the profiling example (`tests/test_profile`) shows roughly twice the
update performance for the default 1000 particles on an RTX 3060-class GPU.

## Visualizing particle velocities

After building the Python extension you can generate a scatter plot of the
particle positions with colors representing their speed:

```console
PYTHONPATH=build/bindings python examples/plot_snapshot.py
```

Running the script produces an image named `snapshot.png` in the
`examples` directory.

Below is a sample output generated by the script:

![Particle velocities](snapshot.png)
